---
- name: pull flocker-container-agent
  command: docker pull clusterhq/flocker-container-agent
  sudo: yes
  when: "'{{ flocker_agents_groupname }}' in group_names"

- name: pull flocker-dataset-agent
  command: docker pull clusterhq/flocker-dataset-agent
  sudo: yes
  when: "'{{ flocker_agents_groupname }}' in group_names"

- name: pull flocker-control-service
  command: docker pull clusterhq/flocker-control-service
  sudo: yes
  when: "'{{ flocker_control_service_groupname }}' in group_names"
  run_once: true

- name: install flocker-container-agent
  sudo: yes
  template:
    src: flocker-container-agent.service.j2
    dest: /etc/systemd/flocker-container-agent.service
  when: "'{{ flocker_agents_groupname }}' in group_names"

- name: install flocker-dataset-agent
  sudo: yes
  template:
    src: flocker-dataset-agent.service.j2
    dest: /etc/systemd/flocker-dataset-agent.service
  when: "'{{ flocker_agents_groupname }}' in group_names"

- name: install flocker-control-service
  sudo: yes
  template:
    src: flocker-control-service.service.j2
    dest: /etc/systemd/flocker-control-service.service
  when: "'{{ flocker_control_service_groupname }}' in group_names"
  run_once: true

- name: pull flocker-docker-plugin
  command: docker pull clusterhq/flocker-docker-plugin
  sudo: yes
  when: "flocker_install_docker_plugin and '{{ flocker_agents_groupname }}' in group_names"

- name: create docker plugins dir
  file:
    path: "/run/docker/plugins"
    state: directory
  delegate_to: 127.0.0.1
  when: "flocker_install_docker_plugin and '{{ flocker_agents_groupname }}' in group_names"

- name: install flocker-docker-plugin
  sudo: yes
  template:
    src: flocker-docker-plugin.service.j2
    dest: /etc/systemd/flocker-docker-plugin.service
  when: "flocker_install_docker_plugin and '{{ flocker_agents_groupname }}' in group_names"

- include: configure_plugin.yml
  when: "flocker_install_docker_plugin and '{{ flocker_agents_groupname }}' in group_names"
